- # vc6 内存分配

![vc6 内存分配 7](https://github.com/havenow/my-C-plus-plus/blob/master/C%2B%2B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/images/vc6%20%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%207.png) 


PHEADER __cdecl __sbh_alloc_new_region (void)
{
	PHEADER     pHeader;
	//  create a new entry in the header list
  
	//  if list if full, realloc to extend its size
	if (__sbh_cntHeaderList == __sbh_sizeHeaderList)
	{
		if (!(pHeader = (PHEADER)HeapReAlloc(_crtheap, 0, __sbh_pHeaderList,
			(__sbh_sizeHeaderList + 16) * sizeof(HEADER))))
			return NULL;

		//  update pointer and counter values
		__sbh_pHeaderList = pHeader;
		__sbh_sizeHeaderList += 16;
	}

	//  point to new header in list
	pHeader = __sbh_pHeaderList + __sbh_cntHeaderList;

	//  allocate a new region associated with the new header
	if (!(pHeader->pRegion = (PREGION)HeapAlloc(_crtheap, HEAP_ZERO_MEMORY,
		sizeof(REGION))))
		return NULL;
  
  // #define BYTES_PER_PARA      16
  // #define PARAS_PER_PAGE      256     /*  tunable value */
  // #define PAGES_PER_GROUP     8       /*  tunable value */
  // #define GROUPS_PER_REGION   32      /*  tunable value (max 32) */

  // #define BYTES_PER_PAGE      (BYTES_PER_PARA * PARAS_PER_PAGE) = 16 * 256 = 4KB
  // #define BYTES_PER_GROUP     (BYTES_PER_PAGE * PAGES_PER_GROUP) = 8 * 4KB = 32 KB
  // #define BYTES_PER_REGION    (BYTES_PER_GROUP * GROUPS_PER_REGION) = 32KB * 32 = 1 MB

	//  reserve address space for heap data in the region
	if ((pHeader->pHeapData = VirtualAlloc(0, BYTES_PER_REGION,
		MEM_RESERVE, PAGE_READWRITE)) == NULL)
	{
		HeapFree(_crtheap, 0, pHeader->pRegion);
		return NULL;
	}

	//  initialize alloc and commit group vectors
	pHeader->bitvEntryHi = 0;
	pHeader->bitvEntryLo = 0;
	pHeader->bitvCommit = BITV_COMMIT_INIT;

	//  complete entry by incrementing list count
	__sbh_cntHeaderList++;

	//  initialize index of group to try first (none defined yet)
	pHeader->pRegion->indGroupUse = -1;

	return pHeader;
}
